{% extends 'base.html' %}

{% load static %}

{% block css_files %}
<link rel="stylesheet" href="{% static 'blog/post-details.css' %}" />
{% endblock %}

{% block title %}
{{ post.title }}
{% endblock %}

{% block content %}
<div class="article-post-content">
  <section id="summary">
    <h2>{{ post.title }}</h2>
    <div>
      {% for tag in post_tags %}
      <span class="tag">{{ tag.caption }}</span>
      {% endfor %}
    </div>
    <div id="read-later">
      {% if user.is_authenticated %}
        {% with saved_posts=user.userprofile.saved_content.posts.all %}
          <form action="{% url 'blog:read-later' %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="content_id" value="{{ post.id }}" />
            <input type="hidden" name="content_type" value="post" />
            <input type="hidden" name="next" value="{{ request.path }}" />
            <button type="submit">
              {% if post in user.savedcontent.posts.all %}
                Remove from Saved Articles
              {% else %}
                Save Article
              {% endif %}
            </button>
          </form>
        {% endwith %}
      {% else %}
        <a href="{% url 'users1:login' %}?next={{ request.path }}">
          Log in to save articles
        </a>
      {% endif %}
    </div>

    <article>
      <img src="{{ post.image.url }}" alt="{{ post.title }}" />
      <address>
        By <a href="mailto:{{ post.author.email }}">{{ post.author }}</a>
      </address>
      <div class="last-updated">
        Last updated on <time>{{ post.date|date:"d M Y" }}</time>
      </div>
    </article>
  </section>
  <main>
    <div class="article-content">{{ post.content|linebreaks}}</div>
  </main>
</div>

{% if user.is_authenticated %}
<div class="comment-section">
  <section id="comment-form">
    <form action="{% url 'blog:post-detail-page' slug=post.slug %}" method="post">
      {% csrf_token %}
      {{ comment_form.as_p }}
      <button type="submit">Submit Comment</button>
    </form>
  </section>

  <section id="comments">
    <ul>
      {% for comment in comments %}
      <div class="comment">
        <p>{{ comment.text }}</p>

        <!-- Edit/Delete links -->
        {% if comment.user == request.user %}
            <button class="edit-comment-button" data-comment-id="{{ comment.id }}">Edit</button>
            <a href="{% url 'blog:delete_comment' comment.id %}" onclick="return confirm('Are you sure?');">Delete</a>
        {% endif %}

        <!-- Edit Comment Form -->
        <div class="edit-comment-form" id="edit-comment-form-{{ comment.id }}" style="display:none;">
            <form method="post" action="{% url 'blog:edit_comment' comment.id %}">
                {% csrf_token %}
                <textarea name="text">{{ comment.text }}</textarea>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>
{% endfor %}
    </ul>
  </section>
</div>
{% else %}
<p>
  Please <a href="{% url 'users1:login' %}?next={{ request.path }}">log in</a> to post a comment.
</p>
{% endif %}

<script>
  // Code for handling the display of the edit comment form
  document.querySelectorAll('.edit-comment-button').forEach(button => {
    button.addEventListener('click', function() {
      var commentId = this.getAttribute('data-comment-id');
      var form = document.getElementById('edit-comment-form-' + commentId);
      form.style.display = 'block';
    });
  });

  // Ensure the DOM is fully loaded before attaching event listeners
  document.addEventListener('DOMContentLoaded', function() {
    var readLaterForm = document.querySelector('#read-later form');
    var readLaterButton = readLaterForm.querySelector('button[type="submit"]');

    // Event listener for the read-later form submission
    readLaterForm.onsubmit = function(event) {
      event.preventDefault(); // Prevent the form from submitting normally

      var xhr = new XMLHttpRequest();
      xhr.open('POST', readLaterForm.action, true);
      xhr.setRequestHeader('X-CSRFToken', readLaterForm.querySelector('[name=csrfmiddlewaretoken]').value);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

      // Prepare the data from the form for sending
      var formData = new FormData(readLaterForm);

      // Handle the response from the server
      xhr.onload = function() {
        if (xhr.status === 200) {
          // Parse the JSON response
          var response = JSON.parse(xhr.responseText);
          if (response.saved) {
            readLaterButton.textContent = 'Remove from Saved Articles';
            readLaterButton.classList.add('saved');
          } else {
            readLaterButton.textContent = 'Save Article';
            readLaterButton.classList.remove('saved');
          }
        } else {
          // Handle errors here
          alert('An error occurred!');
        }
      };

      // Convert FormData to URL encoded string
      var urlEncodedData = "";
      var urlEncodedDataPairs = [];
      for(var pair of formData.entries()) {
         urlEncodedDataPairs.push(encodeURIComponent(pair[0]) + '=' + encodeURIComponent(pair[1]));
      }
      urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');

      // Send the form data
      xhr.send(urlEncodedData);
    };
  });
</script>
{% endblock %}